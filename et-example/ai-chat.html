<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 智能助手</title>
    <style>
        /* 自由设置的样式，以实现功能为主 */
        html, body { height: 100%; margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        #app { display: flex; flex-direction: column; height: 100%; background-color: #f4f5f7; }
        
        /* 聊天内容区域 */
        .chat-content { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .msg { margin-bottom: 20px; display: flex; flex-direction: column; }
        .bubbleResponse { align-self: flex-start; background-color: #fff; border-radius: 18px; padding: 10px 15px; max-width: 85%; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .bubbleRight { align-self: flex-end; background-color: #4a90e2; color: white; border-radius: 18px; padding: 10px 15px; max-width: 85%; }
        .think { border-top: 1px dashed #eee; margin-top: 8px; padding-top: 8px; font-size: 0.9em; color: #888; }
        .loading-gif { width: 20px; vertical-align: middle; }
        #chart-container { width: 100%; margin-top: 10px; height: 350px; border: 1px solid #eee; background: #fff; display: none; }

        /* 底部输入区域 */
        .content-input-section { box-shadow: 0 -2px 5px rgba(0,0,0,0.05); background-color: #fff; }
        .option-btns { padding: 10px 15px; border-bottom: 1px solid #f0f0f0; }
        .option-btns button { border: 1px solid #ccc; background-color: #f9f9f9; padding: 5px 10px; border-radius: 15px; cursor: pointer; margin-right: 10px; }
        .option-btns button.active { background-color: #4caf50; color: white; border-color: #4caf50; }
        .textarea-wrapper { padding: 10px 15px; }
        .textarea-wrapper textarea { width: 100%; border: none; outline: none; resize: none; font-size: 1em; height: 60px; }
        .send-bar { display: flex; justify-content: flex-end; align-items: center; padding: 0 15px 10px 15px; }
        .send-bar button { border: none; background-color: #4a90e2; color: white; padding: 8px 20px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        .send-bar button.stop-btn { background-color: #e94b3c; }
    </style>
</head>
<body>

<div id="app">
    <!-- 聊天内容区域 -->
    <div class="chat-content" ref="chatContainer">
        <div v-for="item in info" class="msg">
            <!-- AI回复消息 -->
            <div v-if="item.type === 'response'" class="bubbleResponse">
                <div v-html="item.htmlMsg || item.msg"></div>
                <!-- 思考区域 -->
                <div class="think" v-if="item.think">
                    <strong>思考过程:</strong>
                    <div v-html="item.think"></div>
                </div>
                 <!-- 图表容器 -->
                <div id="chart-container" v-if="item.plotSpec"></div>
            </div>

            <!-- 用户提问 -->
            <div v-if="item.type === 'question'" class="bubbleRight">
                <span>{{item.msg}}</span>
            </div>
        </div>
    </div>

    <!-- 底部输入区域 -->
    <section class="content-input-section">
        <div class="option-btns">
            <button @click="toggleAnalysisMode" :class="{ active: isAnalysisMode }">
                {{ isAnalysisMode ? '分析模式: 开' : '分析模式: 关' }}
            </button>
        </div>
        <div class="textarea-wrapper">
            <textarea v-model="inputVal" placeholder="请输入内容..." @keyup.enter.prevent="sendMessage"></textarea>
        </div>
        <div class="send-bar">
            <button  @click="stopGeneration" class="stop-btn">停止</button>
            <button @click="sendMessage" :disabled="loading">发送</button>
        </div>
    </section>
</div>

<!-- Core Libraries -->
<script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/danfojs@1.1.2/lib/bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- Application Logic -->
<script src="./js/prompts.js"></script>
<script src="./js/dataAnalysisAgent.js"></script>
<script>
    // Helper function to simulate WPS environment for browser testing
    function getWpsApplication() {
        if (typeof wps !== 'undefined' && wps.Application) {
            return wps.Application;
        }
        // Mock WPS Application for testing outside the WPS environment
        console.warn("WPS环境未找到，正在使用模拟的WPS对象。");
        return {
            ActiveSheet: {
                Selection: {
                    Value: () => [
                        ["订单ID", "订单日期", "产品类别", "产品名称", "单价", "数量", "总价", "客户评分", "地区"],
                        ["ORD001", 20230115, "电子产品", "智能手机", 5000, 2, "￥10,000", 4.5, "华东"],
                        ["ORD002", 20230116, "服装", "羽绒服", 800, 1, "￥800", 4.8, "华北"],
                        ["ORD003", 20230117, "家居用品", "智能台灯", 350, 5, "￥1,750", 4.2, "华南"],
                        ["ORD004", 20230201, "电子产品", "笔记本电脑", 8500, 1, "￥8,500", 4.9, "华东"],
                        ["ORD005", 20230203, "食品", "进口牛肉", 200, 10, "￥2,000", null, "华北"],
                        ["ORD006", 20230205, "服装", "运动鞋", 600, 3, "￥1,800", 4.6, "华中"],
                        ["ORD007", 20230310, "电子产品", "无线耳机", 1200, 2, "￥2,400", 4.7, "华东"],
                        ["ORD008", 20230312, "家居用品", "记忆棉枕头", 300, 4, "￥1,200", 4.3, "西南"],
                        ["ORD009", 20230315, "服装", "牛仔裤", 450, 2, "￥900", 4.4, "华北"],
                        ["ORD010", 20230401, "食品", "有机蔬菜包", 150, 20, "￥3,000", 5, "华东"],
                        ["ORD011", 20230402, "电子产品", "智能手表", 2500, 3, "￥7,500", null, "华南"],
                        ["ORD012", 20230405, "服装", "T恤", 180, 10, "￥1,800", 4.1, "华中"],
                        ["ORD013", 20230510, "家居用品", "吸尘器", 1500, 1, "￥1,500", 4.8, "华北"],
                        ["ORD014", 20230512, "电子产品", "平板电脑", 4000, 2, "￥8,000", 4.6, "西南"],
                        ["ORD015", 20230520, "食品", "坚果礼盒", 250, 8, "￥2,000", 4.9, "华南"]
                    ]
                }
            }
        };
    }

    const vm = new Vue({
        el: '#app',
        data: {
            info: [], // 对话列表
            inputVal: "", // 输入框内容
            loading: false, // 是否正在加载
            isAnalysisMode: false, // 是否为数据分析模式
            stopRequested: false, // 标记是否请求停止
            chartInstance: null, // ECharts 实例
        },
        mounted() {
            // 初始化时显示欢迎信息
            this.addMsgResponse({ msg: "您好！我是您的AI智能助手，您可以向我提问或切换到“分析模式”来分析表格数据。" });
            setTimeout(() => {
                document.getElementById('app').style.opacity = '1';
            }, 0);
        },
        updated() {
            this.scrollToBottom();
        },
        methods: {
            // 滚动到聊天窗口底部
            scrollToBottom() {
                this.$nextTick(() => {
                    const container = this.$refs.chatContainer;
                    container.scrollTop = container.scrollHeight;
                });
            },
            // 添加一条助手消息
            addMsgResponse(response) {
                const newMsg = {
                    type: "response",
                    msg: response.msg || "",
                    htmlMsg: response.htmlMsg || response.msg,
                    think: response.think || "",
                    thinkLoading: response.thinkLoading === true,
                };
                this.info.push(newMsg);
            },
            // 切换分析模式
            toggleAnalysisMode() {
                this.isAnalysisMode = !this.isAnalysisMode;
                if (this.isAnalysisMode) {
                    this.addMsgResponse({ msg: "数据分析模式已开启。请选中WPS中的数据，然后输入您的分析指令。" });
                } else {
                    this.addMsgResponse({ msg: "数据分析模式已关闭。" });
                }
            },
            // 发送消息的总入口
            sendMessage() {
                const messageText = this.inputVal.trim();
                if (!messageText || this.loading) return;

                this.stopRequested = false; // 重置停止请求标记
                this.info.push({ type: 'question', msg: messageText });
                this.inputVal = '';

                if (this.isAnalysisMode) {
                    this.startDataAnalysis(messageText);
                } else {
                    this.textGenerate(messageText);
                }
            },
            // 停止生成
            stopGeneration() {
                this.stopRequested = true;
                this.loading = false; // 立即禁用按钮，防止重复点击
                console.log("已请求停止生成。");
            },
            // 文本生成/简单问答的入口
            async textGenerate(question) {
                this.loading = true;
                const prompt = `任务需求是：${question}`;
                this.addMsgResponse({ msg: "正在生成...", thinkLoading: true });
                await this.getContentRes({ 'question': prompt });
            },
            // 数据分析的入口
            async startDataAnalysis(userQuery) {
                this.loading = true;
                const data = getWpsApplication().ActiveSheet.Selection.Value();
                if (!data || !Array.isArray(data) || data.length === 0) {
                    this.addMsgResponse({ msg: '错误：无法获取有效的WPS表格数据或未选中任何数据。' });
                    this.loading = false;
                    return;
                }

                // 定义LLM服务，它直接调用我们还原的getContentRes方法
                const llmService = {
                    call: async (history, systemPrompt) => {
                        // 将历史记录和系统提示组合成一个单一的prompt
                        const fullPrompt = `${systemPrompt}\n\n---\n\n以下是历史对话:\n\n${JSON.stringify(history, null, 2)}`;
                        // 返回一个Promise，该Promise在流结束后解析
                        return new Promise(async (resolve) => {
                            await this.getContentRes({ 'question': fullPrompt }, (finalContent) => {
                                resolve(finalContent);
                            });
                        });
                    }
                };

                // 实例化并运行Agent
                const agent = new DataAnalysisAgent(llmService, this.handleAgentProgress.bind(this));
                
                try {
                    // Agent的输出现在由getContentRes处理，这里我们只需要等待它完成
                    const result = await agent.analyze(userQuery, data);
                     if (result.plotSpec) {
                        this.renderChart(result.plotSpec);
                    }
                    // 最终报告由getContentRes直接渲染，或由agent的回调渲染
                    if (result.report && !result.plotSpec) {
                         this.addMsgResponse({ msg: result.report, htmlMsg: marked.parse(result.report) });
                    }
                } catch (error) {
                    this.addMsgResponse({ msg: `分析过程中出现错误: ${error.message}` });
                } finally {
                    this.loading = false;
                }
            },
            // 核心：还原src.txt中的流式请求函数
            async getContentRes(params, onComplete) {
                let reader; // 将reader提升到外部作用域
                try {
                    // 真实、可工作的fetchrequest函数
                    const fetchrequest = async (url, params) => {
                        // --- 配置区域 ---
                        // 请将此处替换为您的真实API Key
                        const apiKey = "sk-a611164dce354645b84ccad97c21fc7c"; 
                        const apiURL = "https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions";
                        // --- 配置区域结束 ---

                        if (!apiKey) {
                            // 如果是模拟模式，则使用下面的模拟流
                            console.log("API Key未配置，将使用模拟的SSE流。");
                            const mockStream = new ReadableStream({
                                start(controller) {
                                    const encoder = new TextEncoder();
                                    const mockResponses = [
                                        { choices: [{ delta: { content: '正在思考如何分析数据...' } }] },
                                        { choices: [{ delta: { content: '第一步，计算总销售额...' } }] },
                                        { choices: [{ delta: { content: '第二步，生成图表...' } }] },
                                    ];

                                    mockResponses.forEach((resp, i) => {
                                        setTimeout(() => {
                                            const dataString = `data: ${JSON.stringify(resp)}\n\n`;
                                            controller.enqueue(encoder.encode(dataString));
                                        }, i * 300);
                                    });

                                    setTimeout(() => {
                                        controller.enqueue(encoder.encode('data: [DONE]\n\n'));
                                        controller.close();
                                    }, mockResponses.length * 300);
                                }
                            });
                            return new Response(mockStream);
                        }

                        // 从params中提取prompt内容
                        const prompt = params.question || "";
                        const messages = [{ role: 'user', content: prompt }];

                        const requestBody = {
                            model: 'qwen-plus',
                            messages: messages,
                            stream: true,
                            temperature: 0.7
                        };

                        return await fetch(apiURL, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${apiKey}`,
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(requestBody)
                        });
                    };
                    
                    // 发起真实请求
                    const response = await fetchrequest(null, params);
                    const lastMsg = this.info[this.info.length - 1];
                    lastMsg.msg = ""; // 清空"正在生成..."

                    if (!response || !response.body) return;

                    reader = response.body.getReader();
                    const decoder = new TextDecoder('utf-8');
                    let output = "";
                    let isThinking = null;

                    while (true) {
                        if (this.stopRequested) {
                            console.log("检测到停止请求，正在中止读取...");
                            await reader.cancel("用户手动停止");
                            this.addMsgResponse({ msg: "[任务已手动停止]" });
                            this.loading = false;
                            break;
                        }

                        const { value, done } = await reader.read();
                        if (done) {
                            if (onComplete) onComplete(output);
                            this.loading = false;
                            break;
                        }
                         
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');

                        for (const line of lines) {
                            if (line.trim() === '' || !line.startsWith('data: ')) continue;
                            if (line.trim() === 'data: [DONE]') continue;

                            try {
                                const jsonStr = line.slice(6);
                                const data = JSON.parse(jsonStr);

                                if (data.choices?.[0]?.delta?.content) {
                                    const deltaContent = data.choices[0].delta.content;
                                    output += deltaContent;
                                    
                                    // 实时更新UI
                                    lastMsg.msg = output;
                                    lastMsg.htmlMsg = marked.parse(output);
                                    lastMsg.thinkLoading = false;
                                    this.$forceUpdate();
                                }
                            } catch (parseError) {
                                console.warn('解析流式数据块失败:', parseError, '原始行:', line);
                            }
                        }
                    }
                } catch (e) {
                    if (e.name === 'AbortError' || e.message === "用户手动停止") {
                        console.log("Fetch请求已成功中止。");
                    } else {
                        console.error("流式请求错误:", e);
                        this.addMsgResponse({ msg: `请求出错: ${e.message}` });
                    }
                    this.loading = false;
                } finally {
                    if (reader && this.stopRequested) {
                        reader.releaseLock();
                    }
                }
            },
            // 处理Agent的进度回调
            handleAgentProgress(progress) {
                // Agent的日志现在通过一个专门的消息类型显示
                this.addMsgResponse({ msg: `[Agent]: ${progress.content}` });
            },
            // 渲染图表
            renderChart(option) {
                const chartDom = document.getElementById('chart-container');
                chartDom.style.display = 'block';
                if (!this.chartInstance) {
                    this.chartInstance = echarts.init(chartDom);
                }
                this.chartInstance.setOption(option);
                this.scrollToBottom();
            }
        }
    });
</script>

</body>
</html>
