<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>VBA转JSapi示例</title>
    <style type="text/css">
        .content {
            font-size: 15px;
            color: darkslategray;
            margin: 5px;
        }

        .content_red {
            font-weight: bold;
            color: red;
        }

        .li {
            cursor: pointer;
            color: blueviolet;
            margin: 10px;
        }

        .def_control {
            height: 100%;
            width: 100%;
            font-size: 18px;
        }

        .btn_box {
            float: left;
            line-height: 3.3em;
            margin-left: 2%;
        }
    </style>
</head>

<body>
    <script type="text/javascript" src='js/main.js'></script>
    <div id="repleaseBookMarkDiv" class="content">
        <div class="btn_box">
            <button class="def_control" type="button" id="JJRBSButton"
                onclick="addHolidays(5,'2020-06-01','2020-06-03')">节假日补数</button>
        </div>
        <div class="btn_box">
            <button class="def_control" type="button" id="TSJJRBSButton"
                onclick="addSHolidays()">特殊节假日补数（全国库存余额，中央库存余额）</button>
        </div>
        <div class="btn_box">
            <button class="def_control" type="button" id="TSJJRBSButton"
                onclick="delExcess('2020-6-1', 2, 2)">删除</button>
        </div>
        
    </div>
</body>

</html>

<script>
    //wps.ApiEvent.AddApiEventListener("WindowActivate", onDocActiveChange) //当前文档切换后的事件回调通知
    var etCells = wps.EtApplication().Worksheets.Item(19).Cells;
    var etWorksheets = wps.EtApplication().Worksheets;
       
    function DateDiff(interval, date1, date2)
    {
        var objInterval = {'D' : 1000 * 60 * 60 * 24, 'H' : 1000 * 60 * 60, 'M' : 1000 * 60, 'S' : 1000, 'T' : 1};
         interval = interval.toUpperCase();
        var dt1 = Date.parse(date1.replace(/-/g, '/'));
        var dt2 = Date.parse(date2.replace(/-/g, '/'));
        try
        {
            return Math.round((dt2 - dt1) / eval('(objInterval.' + interval + ')'));
         }
        catch (e)
        {
            return e.message;
         }
     }
    
    function DateAdd(interval, number, date)
    { 
	    //确保为date类型: 
	    var rDate;
    	var date1;
	    date=convertToDate(date);
	    //alert(new Date(date.setMonth(date.getMonth()-2)));
	    switch(interval.toLowerCase())
	    { 
	        case "y": return new Date(date.setFullYear(date.getFullYear()+number)); 
	        case "m":
	        	date1 = new Date(date.setMonth(date.getMonth()+ 1+number));
	        	rDate = date1.getFullYear() + "-" + date1.getMonth() + "-" + date1.getDate();
	        	return rDate; 
	        case "d": return new Date(date.setDate(date.getDate()+number)); 
	        case "w": return new Date(date.setDate(date.getDate()+7*number)); 
	        case "h": return new Date(date.setHours(date.getHours()+number)); 
	        case "n": return new Date(date.setMinutes(date.getMinutes()+number)); 
	        case "s": return new Date(date.setSeconds(date.getSeconds()+number)); 
	        case "l": return new Date(date.setMilliseconds(date.getMilliseconds()+number)); 
	    } 
	}
    //javascript中定義的replaceAll() 
    String.prototype.replaceAll = function(s1,s2){ 
        return this.replace(new RegExp(s1,"gm"),s2); 
    }; 
    
    //將日期類型格式的字符串轉化為日期類型: 
    function convertToDate(expr){ 
    	
        if(typeof expr=='string'){
        	
            //expr=expr.replaceAll('-','/');
            
            return new Date(Date.parse(expr)); 
        }else{ 
        	
            return expr; 
        } 
    };
    
    /**
    *sumRowcount As Long, beforedate As Date, newDate As Date, ByRef addlines As Integer
    */
    function addHolidays(sumRowcount, beforedate, newDate)
    {
    	var days;
    	var addlines;
    	//2020-05-02
    	//year(beforedate)
        byear = beforedate.substring(0,4);
        //Month(beforedate)
        bmonth = beforedate.substring(5,7);
        //day(beforedate)
        bday = beforedate.substring(8,10);
        
        //判断当前日期与之前日期相差大于1天，为节假日补数
        days = DateDiff("D", beforedate, newDate)
        alert(days);
        var l_ActiveEt = wps.EtApplication().ActiveWorkbook;
        if (days > 1)// Then
        {
        	for(var i = 1; i < days; i ++)
        	{
        		//alert("byear=" + byear + ", bmonth=" + bmonth + ", bday=" + bday);
        		var m = Number(bmonth);
        		var str = byear + "-" + m + "-" + (Number(bday) + i);
        		//alert(str);
        		
        		alert((sumRowcount + i));
        		etCells.Item((sumRowcount + i),1).Formula = str;
        		etCells.Item((sumRowcount + i),2).Formula = etCells.Item(sumRowcount,2).Formula;
        		etCells.Item((sumRowcount + i),3).Formula = etCells.Item(sumRowcount,3).Formula;
        		etCells.Item((sumRowcount + i),4).Formula = etCells.Item(sumRowcount,4).Formula;
        		
        	}
	            //Worksheets("库存曲线").Range("B" & (sumRowcount + i)).Value = Worksheets("库存曲线").Range("B" & (sumRowcount)).Value
	            //Worksheets("库存曲线").Range("C" & (sumRowcount + i)).Value = Worksheets("库存曲线").Range("C" & (sumRowcount)).Value
	            //Worksheets("库存曲线").Range("D" & (sumRowcount + i)).Value = Worksheets("库存曲线").Range("D" & (sumRowcount)).Value
        	    //next
        }
            
        //End If
        addlines = days - 1;
        return addlines;
    }
    
    
    /* '特殊节假日补数（全国库存余额，中央库存余额）
    Private Sub addSHolidays(sumRowcount As Long, beforedate As Date, newDate As Date, ByRef addlines As Integer)
        Dim days As Long
        byear = year(beforedate)
        bmonth = Month(beforedate)
        bday = day(beforedate)
    '判断当前日期与之前日期相差大于1天，为节假日补数
        days = DateDiff("d", beforedate, newDate)
        
        If days > 1 Then
            For i = 1 To days - 1
                Worksheets("库存曲线").Range("G" & (sumRowcount + i)).Value = Worksheets("库存曲线").Range("G" & (sumRowcount)).Value
                Worksheets("库存曲线").Range("L" & (sumRowcount + i)).Value = Worksheets("库存曲线").Range("L" & (sumRowcount)).Value
            Next i
        End If

    End Sub */
    
	function addSHolidays(sumRowcount, beforedate, newDate)
    {
    	var days;
    	//2020-05-02
    	//year(beforedate)
        var byear = beforedate.substring(0,4);
        //Month(beforedate)
        var bmonth = beforedate.substring(5,7);
        //day(beforedate)
        var bday = beforedate.substring(8,10);
        
        
        
        //判断当前日期与之前日期相差大于1天，为节假日补数
        days = DateDiff("D", beforedate, newDate)
        
        if (days > 1)// Then
        {
        	for(var i = 1; i < days; i ++)
       		{
        		etCells.Item((sumRowcount + i),7).Formula = etCells.Item(sumRowcount,7).Formula;
        		etCells.Item((sumRowcount + i),12).Formula = etCells.Item(sumRowcount,12).Formula;
       		}
        }
    }

        /* '判断日期大于14个月
        Private Sub delExcess(newDate As Date, monthnum As Integer, ByRef lines As Long)
            Dim startDate As Date
            Dim endDate As Date

            startDate = Worksheets("库存曲线").Range("A2").Value
            endDate = DateAdd("m", -monthnum, newDate)
            lines = DateDiff("d", startDate, endDate)

            If lines > 0 Then
                Worksheets("库存曲线").Range("A" & 2, "D" & (2 + lines - 1)).Delete shift:=xlUp
            End If
            'Worksheets("库存曲线").Range("A" & 2).Font.Size = 12
            'Worksheets("库存曲线").Range("A" & 2, "D" & (2 + lines - 1)).EntireRow.Delete
            
        End Sub     */
    function delExcess(newDate, monthnum, lines)
    {
    	var startDate;
    	var endDate;
    	    	
    	startDate = etWorksheets.Item("库存曲线").Range("A2").Text;//etCells.Item(2,1).Formula;//Worksheets("库存曲线").Range("A2").Value
    	//alert(startDate);
    	endDate = DateAdd("m", -monthnum, newDate);
    	alert("endDate=" + endDate);
    	
    	lines = DateDiff("D", startDate, endDate);
    	alert(lines)
    	if (lines > 1)// Then
        {
    		etWorksheets.Item("库存曲线").Range("A" + 2, "D" + (2 + lines - 1)).Delete(-4162)
    		//etCells.Item(4 + (sumRowcount + i), 2).Formula
    		//Worksheets("库存曲线").Range("A" & 2, "D" & (2 + lines - 1)).Delete shift:=xlUp
        }
    	
    	return lines
    }
                
                
     /* '模板里节假日补数
     Private Sub addTHolidays(sumRowcount As Long, beforedate As Date, days As Integer)
         byear = year(beforedate)
         bmonth = Month(beforedate)
         bday = day(beforedate)
         'If days > 1 Then
             For i = 1 To days
                 Workbooks("TsasRpt710.xls").Worksheets("库存曲线").Range("A" & (sumRowcount + i)).Value = DateSerial(byear, bmonth, (bday + i))
                 Workbooks("TsasRpt710.xls").Worksheets("库存曲线").Range("B" & (sumRowcount + i)).Value = Worksheets("库存曲线").Range("B" & (sumRowcount)).Value
                 Workbooks("TsasRpt710.xls").Worksheets("库存曲线").Range("C" & (sumRowcount + i)).Value = Worksheets("库存曲线").Range("C" & (sumRowcount)).Value
                 Workbooks("TsasRpt710.xls").Worksheets("库存曲线").Range("D" & (sumRowcount + i)).Value = Worksheets("库存曲线").Range("D" & (sumRowcount)).Value
             Next i
         'End If
     End Sub        */
     
     function addTHolidays(sumRowcount, beforedate, days)
     {
   		//2020-05-02
    	//year(beforedate)
        var byear = beforedate.substring(0,4);
        //Month(beforedate)
        var bmonth = beforedate.substring(5,7);
        //day(beforedate)
        var bday = beforedate.substring(8,10);
        
        if (days > 1)// Then
        {
        	for(var i = 1; i <= days; i ++)
       		{
        		var m = Number(bmonth);
        		var str = byear + "-" + m + "-" + (Number(bday) + i);
        		
        		etWorksheets.Item("库存曲线").Range("A" & (sumRowcount + i)).Text = str;
        		etWorksheets.Item("库存曲线").Range("B" & (sumRowcount + i)).Text = etWorksheets.Item("库存曲线").Range("B" & (sumRowcount)).Text
        		etWorksheets.Item("库存曲线").Range("C" & (sumRowcount + i)).Text = etWorksheets.Item("库存曲线").Range("C" & (sumRowcount)).Text
        		etWorksheets.Item("库存曲线").Range("D" & (sumRowcount + i)).Text = etWorksheets.Item("库存曲线").Range("D" & (sumRowcount)).Text
                
        		//etCells.Item((sumRowcount + i),7).Formula = etCells.Item(sumRowcount,7).Formula;
        		//etCells.Item((sumRowcount + i),12).Formula = etCells.Item(sumRowcount,12).Formula;
       		}
        }
     }
         
      /* '模板里特殊节假日补数（全国库存余额，中央库存余额）
      Private Sub addTSHolidays(sumRowcount As Long, beforedate As Date, days As Integer)
          'If days > 1 Then
              For i = 1 To days
                  Workbooks("TsasRpt710.xls").Worksheets("库存曲线").Range("G" & (sumRowcount + i)).Value = Worksheets("库存曲线").Range("G" & (sumRowcount)).Value
                  Workbooks("TsasRpt710.xls").Worksheets("库存曲线").Range("L" & (sumRowcount + i)).Value = Worksheets("库存曲线").Range("L" & (sumRowcount)).Value
              Next i
          'End If
      End Sub */    
      
      function addTSHolidays(sumRowcount, beforedate, days)
      {
    	  if (days > 1)// Then
          {
          		for(var i = 1; i <= days; i ++)
       			{
        		
	        		etWorksheets.Item("库存曲线").Range("G" & (sumRowcount + i)).Text = etWorksheets.Item("库存曲线").Range("G" & (sumRowcount)).Text
	        		etWorksheets.Item("库存曲线").Range("L" & (sumRowcount + i)).Text = etWorksheets.Item("库存曲线").Range("L" & (sumRowcount)).Text
	        		//etCells.Item((sumRowcount + i),7).Formula = etCells.Item(sumRowcount,7).Formula;
	        		//etCells.Item((sumRowcount + i),12).Formula = etCells.Item(sumRowcount,12).Formula;
       			}
          }             
      }
          
      /* '模板里判断日期大于14个月
      Private Sub delTExcess(lines As Long)
          'For m = (lines + 1) To 2 Step -1
              'Workbooks("TsasRpt710.xls").Worksheets("库存曲线").Rows(m).Delete
          'Next
          If lines > 0 Then
              Workbooks("TsasRpt710.xls").Worksheets("库存曲线").Range("A" & 2, "D" & (2 + lines - 1)).Delete shift:=xlUp
          End If
      End Sub     */
          
      function delTExcess(lines)
      {
       	  if (lines > 0)// Then
       	  {
       			etWorksheets.Item("库存曲线").Range("A" & 2, "D" & (2 + lines - 1)).Delete(-4162);
       	  }
      }
              
              
              
      /* '复制数据到模板里
      Private Sub copyTemplate(path As String, sumRowcount As Long, addlines As Integer, lines As Long, beforedate As Date, newDate As Date, Bvalue As Double, Cvalue As Double, Dvalue As Double, monthnum As Integer, Evalue As Double, Fvalue As Double)
          '修改模板中的库存曲线数据，增加新日期数据。
          Workbooks.Open Filename:=path & "TsasRpt710.xls"
          
          Dim initRowcount As Long
          Dim date710 As Date
          
          '这是为修改前，模板里最大行数
          initRowcount = Workbooks("TsasRpt710.xls").Sheets("库存曲线").UsedRange.Rows.Count
          date710 = Workbooks("TsasRpt710.xls").Sheets("库存曲线").Range("A" & initRowcount).Value
          If initRowcount = sumRowcount And date710 = newDate Then
              '相等则表示已经复制数据到模板里
              Workbooks("TsasRpt710.xls").Close
              
              MsgBox "程序已经执行，当日数据已经添加‘库存曲线’里，无需再执行"
          ElseIf initRowcount + addlines + 1 = sumRowcount + lines Then
              '如果模板里行数加上要添加行数等于文件行数
              '节假日补数
              addTHolidays initRowcount, beforedate, addlines
              
              Workbooks("TsasRpt710.xls").Worksheets("库存曲线").Range("A" & initRowcount + addlines + 1).Value = newDate
              Workbooks("TsasRpt710.xls").Worksheets("库存曲线").Range("B" & initRowcount + addlines + 1).Value = Bvalue
              Workbooks("TsasRpt710.xls").Worksheets("库存曲线").Range("C" & initRowcount + addlines + 1).Value = Cvalue
              Workbooks("TsasRpt710.xls").Worksheets("库存曲线").Range("D" & initRowcount + addlines + 1).Value = Dvalue
              
              '20150806增加节假日模板处理新增全国库存余额，中央库存余额（库存曲线）
                '如果上日是12月31，则不能自动，需要手工
              If Right(CStr(beforedate), 5) <> "12-31" Then
                  initRowcount = Workbooks("TsasRpt710.xls").Worksheets("库存曲线").Range("G1:G366").End(xlDown).Row
                  addTSHolidays initRowcount, beforedate, addlines
                  
                  '20150806增加模板里新增全国库存余额、中央库存余额
                  Workbooks("TsasRpt710.xls").Worksheets("库存曲线").Range("G" & (initRowcount + addlines + 1)).Value = Evalue
                  Workbooks("TsasRpt710.xls").Worksheets("库存曲线").Range("L" & (initRowcount + addlines + 1)).Value = Fvalue

                  
                  '给全国和总库数据补一条数，如果addline = 0；则不添加
                  'If addlines <> 0 Then
                       'Workbooks("TsasRpt710.xls").Worksheets("库存曲线").Range("F" & 2, "N" & (2 + addlines - 1)).Insert shift:=xlDown
                  'End If
              End If
              
              
              delTExcess lines
              
              Workbooks("TsasRpt710.xls").Worksheets("sheet2").Range("O5").Value = monthnum
              
              Workbooks("TsasRpt710.xls").Save
              
              Workbooks("TsasRpt710.xls").Close
              
              MsgBox "程序执行完毕"
          Else
              '删除模板里“库存曲线”里数据用文件里替代
              'delTExcess initRowcount
              
              'For i = 2 To sumRowcount
              
                  'ThisWorkbook.Sheets("库存曲线").Columns("a:d").Copy Workbooks("TsasRpt710.xls").Sheets("库存曲线").Range("a:d")
                  '20150806库存曲线增加很多数据修改拷贝范围
                  ThisWorkbook.Sheets("库存曲线").Columns("a:n").Copy Workbooks("TsasRpt710.xls").Sheets("库存曲线").Range("a:n")
                  
                  'Workbooks("TsasRpt710.xls").Worksheets("库存曲线").Range("A" & i).Value = ActiveWorkbook.Sheets("库存曲线").Range("A" & i).Value
                  'Workbooks("TsasRpt710.xls").Worksheets("库存曲线").Range("B" & i).Value = ActiveWorkbook.Sheets("库存曲线").Range("B" & i).Value
                  'Workbooks("TsasRpt710.xls").Worksheets("库存曲线").Range("C" & i).Value = ActiveWorkbook.Sheets("库存曲线").Range("C" & i).Value
                  'Workbooks("TsasRpt710.xls").Worksheets("库存曲线").Range("D" & i).Value = ActiveWorkbook.Sheets("库存曲线").Range("D" & i).Value
              'Next i

              Workbooks("TsasRpt710.xls").Save
              
              Workbooks("TsasRpt710.xls").Close
              
              MsgBox "模板数据更新完毕"
          End If
          
          
          '复制修改过的模板文件，防止更新时覆盖。TODO 后期考虑此问题
      End Sub */   
      
      function copyTemplate(path, sumRowcount, addlines, lines, beforedate, newDate, Bvalue, Cvalue, Dvalue, monthnum, Evalue, Fvalue))
      {
    	  wps.EtApplication().Workbooks.Open(path + "TsasRpt710.xls");
    	  var initRowcount;
    	  var date710;
    	  //Workbooks("TsasRpt710.xls").Sheets("库存曲线").UsedRange.Rows.Count
    	  initRowcount = wps.EtApplication().Workbooks.Item("TsasRpt710.xls").Worksheets.Item("库存曲线").UsedRange.Rows.Count;
    	  date710 = wps.EtApplication().Workbooks.Item("TsasRpt710.xls").Worksheets.Item("库存曲线").Range("A" & initRowcount).Text;
    	  
    	  if (initRowcount == sumRowcount && date710 == newDate)
   		  {
    		  //相等则表示已经复制数据到模板里
    	      wps.EtApplication().Workbooks.Item("TsasRpt710.xls").Close;
    	      
    	      alert("程序已经执行，当日数据已经添加‘库存曲线’里，无需再执行");
   		  }
    	  else if (initRowcount + addlines + 1 == sumRowcount + lines)
    	  {
	  		    //'如果模板里行数加上要添加行数等于文件行数
	  	        //'节假日补数
	  	        addTHolidays(initRowcount, beforedate, addlines);
	  	        
	  	      	wps.EtApplication().Workbooks.Item("TsasRpt710.xls").Worksheets.Item("库存曲线").Range("A" & initRowcount + addlines + 1).Text = newDate
	  	    	wps.EtApplication().Workbooks.Item("TsasRpt710.xls").Worksheets.Item("库存曲线").Range("B" & initRowcount + addlines + 1).Text = Bvalue
	  	    	wps.EtApplication().Workbooks.Item("TsasRpt710.xls").Worksheets.Item("库存曲线").Range("C" & initRowcount + addlines + 1).Text = Cvalue
	  	    	wps.EtApplication().Workbooks.Item("TsasRpt710.xls").Worksheets.Item("库存曲线").Range("D" & initRowcount + addlines + 1).Text = Dvalue
	  	        
	  	        //'20150806增加节假日模板处理新增全国库存余额，中央库存余额（库存曲线）
	  	        //'如果上日是12月31，则不能自动，需要手工
	  	        
	  	    	if (Right(CStr(beforedate), 5) <> "12-31")
	  	    	{
	  	    		initRowcount = wps.EtApplication().Workbooks.Item("TsasRpt710.xls").Worksheets.Item("库存曲线").Range("G1:G366").End(-4121).Row
		            addTSHolidays(initRowcount, beforedate, addlines);
		            
		            //'20150806增加模板里新增全国库存余额、中央库存余额
		            wps.EtApplication().Workbooks.Item("TsasRpt710.xls").Worksheets.Item("库存曲线").Range("G" & (initRowcount + addlines + 1)).Text = Evalue
		            wps.EtApplication().Workbooks.Item("TsasRpt710.xls").Worksheets.Item("库存曲线").Range("L" & (initRowcount + addlines + 1)).Text = Fvalue

		            
		            //'给全国和总库数据补一条数，如果addline = 0；则不添加
		            //'If addlines <> 0 Then
		            //     'Workbooks("TsasRpt710.xls").Worksheets("库存曲线").Range("F" & 2, "N" & (2 + addlines - 1)).Insert shift:=xlDown
		            //'End If
	
	  	    	}
	  	      	
	  	      delTExcess(lines);
	          
	  	      wps.EtApplication().Workbooks.Item("TsasRpt710.xls").Worksheets.Item("sheet2").Range("O5").Text = monthnum
	          
	  	  	  wps.EtApplication().Workbooks.Item("TsasRpt710.xls").Save
	          
	  		  wps.EtApplication().Workbooks.Item("TsasRpt710.xls").Close
	          
	          alert("程序执行完毕");
    	  }
          else
       	  {
	          //'删除模板里“库存曲线”里数据用文件里替代
	          //'delTExcess initRowcount
	          
	          //'For i = 2 To sumRowcount
	          
	          //    'ThisWorkbook.Sheets("库存曲线").Columns("a:d").Copy Workbooks("TsasRpt710.xls").Sheets("库存曲线").Range("a:d")
	          //    '20150806库存曲线增加很多数据修改拷贝范围
	          //---------------------------------------------------------
	          //--------------------------------------------------------
	          //这边需要写模板的文件名???????????????????????????????????
	          //ThisWorkbook.Sheets("库存曲线").Columns("a:n").Copy Workbooks("TsasRpt710.xls").Sheets("库存曲线").Range("a:n")
	              wps.EtApplication().Workbooks.Item("").Worksheets.Item("库存曲线").Columns("a:n").Copy wps.EtApplication().Workbooks.Item("TsasRpt710.xls").Worksheets.Item("库存曲线").Range("a:n");
	              
	          //    'Workbooks("TsasRpt710.xls").Worksheets("库存曲线").Range("A" & i).Value = ActiveWorkbook.Sheets("库存曲线").Range("A" & i).Value
	          //    'Workbooks("TsasRpt710.xls").Worksheets("库存曲线").Range("B" & i).Value = ActiveWorkbook.Sheets("库存曲线").Range("B" & i).Value
	          //    'Workbooks("TsasRpt710.xls").Worksheets("库存曲线").Range("C" & i).Value = ActiveWorkbook.Sheets("库存曲线").Range("C" & i).Value
	          //    'Workbooks("TsasRpt710.xls").Worksheets("库存曲线").Range("D" & i).Value = ActiveWorkbook.Sheets("库存曲线").Range("D" & i).Value
	          //'Next i

	          wps.EtApplication().Workbooks.Item("TsasRpt710.xls").Save
	          
	          wps.EtApplication().Workbooks.Item("TsasRpt710.xls").Close
	          
	          alert("模板数据更新完毕");	     
    	  }
      }
      
      
      
      
</script>